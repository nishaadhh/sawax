<%- include("../../views/partials/user/header") %>

<link rel="stylesheet" href="/css/shop.css">
<title>SAWAX | Shop </title>

<style>
    :root {
        --primary: #1a1a1a;
        --secondary: #f8f8f8;
        --accent: #d4af37;
        --text: #333;
        --light-text: #777;
        --border: #e0e0e0;
    }

    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 20px;
        padding: 20px;
    }

    .product-card {
        border: 1px solid var(--border);
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        background: #fff;
        transition: transform 0.2s ease-in-out;
    }

    .product-card:hover {
        transform: scale(1.02);
    }

    .out-of-stock-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        padding: 4px 8px;
        font-size: 12px;
        font-weight: 600;
        border-radius: 4px;
        z-index: 10;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .product-image {
        position: relative;
    }

    .disabled-btn {
        background: #ccc !important;
        color: #666 !important;
        pointer-events: none;
        opacity: 0.7;
    }

    .product-image img {
        width: 100%;
        height: 299px;
        object-fit: cover;
    }

    .product-details {
        padding: 15px;
    }

    .product-name {
        font-size: 18px;
        font-weight: 600;
        color: var(--primary);
    }

    .product-price {
        color: var(--accent);
        font-size: 16px;
        margin-top: 5px;
    }

    .view-button {
        font-weight: 600;
        font-size: small;
        margin-top: 10px;
        display: inline-block;
        padding: 8px 12px;
        background: linear-gradient(135deg,#e0ad05, #b5990c);
        color: var(--primary);
        border-radius: 10px;
        text-decoration: none;
    }

    .view-button:hover {
        background: linear-gradient(135deg,#e6ba2b, #ffc20a);
    }

    .wishlist-btn:hover{
        color:red
    }
    .wishlist-btn i.wishlist-active{ color:red; }

    .shop-sidebar {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .sidebar-section {
        margin-bottom: 20px;
    }

    .sidebar-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--primary);
        margin-bottom: 10px;
    }

    .search-container {
        display: flex;
        align-items: center;
        border: 1px solid var(--border);
        border-radius: 20px;
        overflow: hidden;
    }

    .search-input {
        border: none;
        padding: 8px;
        flex: 1;
        outline: none;
        font-size: 14px;
    }

    .search-btn {
        background: linear-gradient(135deg,#e6ba2b, #ffc20a);;
        border: none;
        padding: 8px 12px;
        color: white;
        cursor: pointer;
        transition: background 0.3s;
    }

    .search-btn:hover {
        background: linear-gradient(135deg,#e6ba2b, #ffc20a);;
        color: #000000;
    }

    .category-list {
        list-style: none;
        padding: 0;
    }

    .category-item {
        margin-bottom: 10px;
    }

    .category-link {
        color: var(--text);
        font-size: 14px;
        text-decoration: none;
        display: flex;
        justify-content: space-between;
        transition: color 0.3s;
        cursor: pointer;
    }

    .category-link:hover {
        color: var(--accent);
    }

    .category-link.active {
        color: var(--accent);
        font-weight: 600;
    }

    .filter-group {
        margin-bottom: 15px;
    }

    .filter-group-title {
        font-size: 16px;
        color: var(--primary);
        margin-bottom: 10px;
    }

    .price-range {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .range-slider {
        width: 100%;
    }

    .price-inputs {
        display: flex;
        gap: 10px;
    }

    .price-input {
        width: 50%;
        padding: 8px;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 14px;
    }

    .alpha-filter {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .alpha-checkbox {
        display: none;
    }

    .alpha-label {
        padding: 5px 10px;
        border: 1px solid var(--border);
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        color: var(--text);
        transition: background 0.3s, color 0.3s;
    }

    .alpha-checkbox:checked + .alpha-label {
        background: var(--accent);
        color: var(--primary);
    }

    .apply-filter {
         background: linear-gradient(135deg, #e5af00, #b9880c);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        text-transform: uppercase;
        transition: background 0.3s;
    }

    .apply-filter:hover {
        background: linear-gradient(135deg,#ffcd2a, #b29434);
        
    }

    .shop-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .sort-select {
        padding: 8px;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 14px;
    }

    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
        gap: 5px;
    }

    .pagination a {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text);
        text-decoration: none;
        transition: background 0.3s;
        cursor: pointer;
    }

    .pagination a:hover, .pagination a.active {
        background: linear-gradient(135deg, #e5af00, #bd8617);
        color: var(--primary);
        border-color: var(--accent);
    }

    .reset-filters {
        background: transparent;
        border: 1px solid var(--accent);
        color: var(--accent);
        padding: 8px 16px;
        border-radius: 15px;
        cursor: pointer;
        font-size: 10px;
        margin-top: 10px;
        transition: background 0.3s, color 0.3s;
    }

    .reset-filters:hover {
        background: #d4af37;
        color: white;
       
    }

    .loading {
        text-align: center;
        padding: 20px;
        color: var(--light-text);
    }

    .shop-layout {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 30px;
    }

   
    .page-title {
        position: relative;
        padding: 120px 20px 80px;
        background: linear-gradient(135deg, #000000 0%, #000000 100%);
        overflow: hidden;
        perspective: 1000px;
        text-align: center;
    }

    .page-title::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 20% 50%, rgba(212, 175, 55, 0.15) 0%, transparent 50%),
            radial-gradient(circle at 80% 80%, rgba(212, 175, 55, 0.1) 0%, transparent 50%);
        animation: backgroundPulse 8s ease-in-out infinite;
    }

    @keyframes backgroundPulse {
        0%, 100% { opacity: 0.3; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(1.1); }
    }

    .page-title::after {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        background-image: 
            radial-gradient(2px 2px at 20% 30%, rgba(212, 175, 55, 0.4), transparent),
            radial-gradient(2px 2px at 60% 70%, rgba(212, 175, 55, 0.4), transparent),
            radial-gradient(1px 1px at 50% 50%, rgba(255, 255, 255, 0.4), transparent),
            radial-gradient(1px 1px at 80% 10%, rgba(255, 255, 255, 0.4), transparent);
        background-size: 200% 200%;
        animation: particleFloat 20s linear infinite;
    }

    @keyframes particleFloat {
        0% { background-position: 0% 0%; }
        100% { background-position: 100% 100%; }
    }

    .page-title .container {
        position: relative;
        z-index: 2;
    }

    .page-title h2 {
        font-size: 4rem;
        font-weight: 600;
        background: linear-gradient(135deg, #d4af37 0%, #f8e45f 50%, #d4af37 100%);
        background-size: 200% auto;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 20px;
        position: relative;
        animation: gradientShift 4s ease infinite;
    }

    @keyframes gradientShift {
        0%, 100% { background-position: 0% center; }
        50% { background-position: 100% center; }
    }

    .page-title h2 span {
        display: inline-block;
        animation: letterBounce 0.6s ease forwards;
        opacity: 0;
    }

    @keyframes letterBounce {
        0% {
            opacity: 0;
            transform: translateY(-100px) scale(0);
        }
        50% {
            transform: translateY(10px) scale(1.1);
        }
        100% {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .page-title h2 span:nth-child(1) { animation-delay: 0.1s; }
    .page-title h2 span:nth-child(2) { animation-delay: 0.15s; }
    .page-title h2 span:nth-child(3) { animation-delay: 0.2s; }
    .page-title h2 span:nth-child(4) { animation-delay: 0.25s; }
    .page-title h2 span:nth-child(5) { animation-delay: 0.3s; }
    .page-title h2 span:nth-child(6) { animation-delay: 0.35s; }
    .page-title h2 span:nth-child(7) { animation-delay: 0.4s; }
    .page-title h2 span:nth-child(8) { animation-delay: 0.45s; }
    .page-title h2 span:nth-child(9) { animation-delay: 0.5s; }
    .page-title h2 span:nth-child(10) { animation-delay: 0.55s; }
    .page-title h2 span:nth-child(11) { animation-delay: 0.6s; }
    .page-title h2 span:nth-child(12) { animation-delay: 0.65s; }
    .page-title h2 span:nth-child(13) { animation-delay: 0.7s; }
    .page-title h2 span:nth-child(14) { animation-delay: 0.75s; }
    .page-title h2 span:nth-child(15) { animation-delay: 0.8s; }
    .page-title h2 span:nth-child(16) { animation-delay: 0.85s; }
    .page-title h2 span:nth-child(17) { animation-delay: 0.9s; }
    .page-title h2 span:nth-child(18) { animation-delay: 0.95s; }
    .page-title h2 span:nth-child(19) { animation-delay: 1s; }
    .page-title h2 span:nth-child(20) { animation-delay: 1.05s; }

    .page-title h2::after {
        content: '';
        position: absolute;
        bottom: -15px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 4px;
        background: linear-gradient(90deg, transparent, #d4af37, transparent);
        box-shadow: 0 0 20px #d4af37;
        animation: underlineExpand 1s 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    @keyframes underlineExpand {
        to { width: 80%; }
    }

    .page-title p {
        font-size: 1.3rem;
        color: #e0e0e0;
        opacity: 0;
        animation: fadeInUp 1s 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        transform: translateY(30px);
        letter-spacing: 1px;
        position: relative;
    }

    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .sparkle {
        position: absolute;
        width: 4px;
        height: 4px;
        background: #d4af37;
        border-radius: 50%;
        box-shadow: 0 0 10px #d4af37;
        animation: sparkleAnimation 2s ease-in-out infinite;
        pointer-events: none;
    }

    @keyframes sparkleAnimation {
        0%, 100% {
            opacity: 0;
            transform: scale(0) rotate(0deg);
        }
        50% {
            opacity: 1;
            transform: scale(1) rotate(180deg);
        }
    }

    .page-title:hover h1 {
        animation: gradientShift 4s ease infinite,
                   glowPulse 2s ease-in-out infinite;
    }

    @keyframes glowPulse {
        0%, 100% {
            filter: drop-shadow(0 0 10px rgba(212, 175, 55, 0.5));
        }
        50% {
            filter: drop-shadow(0 0 30px rgba(212, 175, 55, 0.9));
        }
    }

    @media (max-width: 768px) {
        .shop-layout {
            grid-template-columns: 1fr;
        }
        
        .shop-sidebar {
            order: 2;
        }
        
        .shop-products {
            order: 1;
        }

        .page-title {
            padding: 80px 20px 60px;
        }

        .page-title h1 {
            font-size: 2.5rem;
        }

        .page-title p {
            font-size: 1rem;
        }
    }
</style>

<section class="page-title">
    <div class="container">
        <h2 >Our Collection</h2>
        <p>Discover exceptional timepieces crafted for distinction</p>
    </div>
</section>

<section class="shop-section">
    <div class="container">
        <div class="shop-layout">
            <!-- Sidebar -->
            <div class="shop-sidebar">
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Search</h3>
                    <form id="search-form">
                        <div class="search-container">
                            <input type="text" name="query" id="search-input" class="search-input" placeholder="Search watches..." value="<%= searchQuery || '' %>">
                            <button type="submit" class="search-btn"><i class="fa-solid fa-magnifying-glass"></i></button>
                        </div>
                    </form>
                </div>

                <div class="sidebar-section">
                    <h3 class="sidebar-title">Categories</h3>
                    <ul class="category-list">
                        <li class="category-item">
                            <a class="category-link" data-category="" onclick="filterByCategory('')">
                                <span>All Categories</span>
                                <span class="category-count">(<%= totalProducts %>)</span>
                            </a>
                        </li>
                        <% category.forEach(cat => { %>
                            <li class="category-item">
                                <a class="category-link" data-category="<%= cat._id %>" onclick="filterByCategory('<%= cat._id %>')">
                                    <span><%= cat.name %></span>
                                    <span class="category-count">(<%= cat.productCount || 0 %>)</span>
                                </a>
                            </li>
                        <% }) %>
                    </ul>
                </div>

                <div class="sidebar-section">
                    <h3 class="sidebar-title">Price Range</h3>
                    <div class="price-range">
                        <div class="price-inputs">
                            <input type="number" id="minPriceInput" class="price-input" placeholder="Min" value="<%= minPrice || '' %>" min="0">
                            <input type="number" id="maxPriceInput" class="price-input" placeholder="Max" value="<%= maxPrice || '' %>" min="0">
                        </div>
                        <button type="button" class="apply-filter" onclick="applyPriceFilter()">Apply Price Filter</button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <button type="button" class="reset-filters" onclick="resetAllFilters()">Reset All Filters</button>
                </div>
            </div>

            <!-- Products Main -->
            <div class="shop-products grid-view">
                <div class="shop-controls">
                    <div class="products-found" id="products-found">
                        Showing <%= (currentPage - 1) * 9 + 1 %>-<%= Math.min(currentPage * 9, totalProducts) %> of <%= totalProducts %> products
                    </div>
                    <div class="shop-actions">
                        <div class="view-options">
                            <button class="view-btn active" data-view="grid">☰</button>
                        </div>
                        <select class="sort-select" id="sort-select">
                            <option value="relevance" <%= sort === 'relevance' ? 'selected' : '' %>>Relevance</option>
                            <option value="price-low" <%= sort === 'price-low' ? 'selected' : '' %>>Price: Low to High</option>
                            <option value="price-high" <%= sort === 'price-high' ? 'selected' : '' %>>Price: High to Low</option>
                            <option value="newest" <%= sort === 'newest' ? 'selected' : '' %>>Newest First</option>
                            <option value="bestselling" <%= sort === 'bestselling' ? 'selected' : '' %>>Bestselling</option>
                        </select>
                    </div>
                </div>

                <div class="product-grid" id="product-grid">
                    <% if (products.length > 0) { %>
                        <% products.forEach(product => { %>
                            <div class="product-card">
                                <div class="product-image">
                                    <img src="/<%= product.productImage[0] %>" alt="<%= product.productName %>">
                                    <% if (product.quantity === 0) { %>
                                        <div class="out-of-stock-badge">Out of Stock</div>
                                    <% } %>
                                </div>
                                <div class="product-details">
                                    <h3 class="product-name"><%= product.productName %></h3>
                                    <p class="product-brand">Brand: <%= product.brand %></p>
                                    <span style="display: flex; gap: 10px; align-items: center;">
                                        <% if (product.regularPrice !== product.salePrice) { %>
                                            <del><p class="product-price">₹ <%= product.regularPrice %></p></del>
                                        <% } %>
                                        <p class="product-price">₹ <%= product.salePrice %></p>
                                    </span>
                                    <p class="product-color">Color: <%= product.color %></p>
                                    <p class="product-description"><%= product.description.slice(0, 100) %>...</p>

                                    <% if (product.quantity > 0) { %>
                                        <a href="/product/<%= product._id %>" class="view-button">View Product</a>
                                    <% } else { %>
                                        <a href="/product/<%= product._id %>" class="view-button disabled-btn" 
                                           style="background: #ccc; cursor: not-allowed; pointer-events: none;">
                                           Out of Stock
                                        </a>
                                    <% } %>

                                    <a class="wishlist-btn" onclick="addToWishlist('<%= product._id %>')">
                                        <i class="fa-solid fa-heart <%= (user && user.wishlist && user.wishlist.some(w => String(w.id) === String(product._id))) ? 'wishlist-active' : '' %>"></i>
                                    </a>
                                </div>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <p style="text-align: center; color: var(--light-text); font-size: 18px;">
                            No products found. Try adjusting your filters.
                        </p>
                    <% } %>
                </div>

                <!-- Pagination -->
                <div class="pagination" id="pagination"></div>
            </div>
        </div>
    </div>
</section>

<script>
// TITLE ANIMATION SCRIPT
document.addEventListener('DOMContentLoaded', function() {
    function splitTextToSpans(element) {
        const text = element.textContent;
        element.innerHTML = '';
        
        for (let i = 0; i < text.length; i++) {
            const span = document.createElement('span');
            span.textContent = text[i] === ' ' ? '\u00A0' : text[i];
            span.style.opacity = '0';
            span.style.transform = 'translateY(-100px) scale(0)';
            element.appendChild(span);
        }
    }

    function createSparkles() {
        const pageTitle = document.querySelector('.page-title');
        const container = document.querySelector('.page-title .container');
        
        if (!pageTitle || !container) return;
        
        setInterval(() => {
            const sparkle = document.createElement('div');
            sparkle.className = 'sparkle';
            
            const rect = container.getBoundingClientRect();
            const x = Math.random() * rect.width;
            const y = Math.random() * rect.height;
            
            sparkle.style.left = x + 'px';
            sparkle.style.top = y + 'px';
            sparkle.style.animationDelay = Math.random() * 2 + 's';
            
            pageTitle.appendChild(sparkle);
            
            setTimeout(() => sparkle.remove(), 2000);
        }, 800);
    }

    // Initialize on page load
    const titleElement = document.querySelector('.page-title h1');
    if (titleElement) {
        splitTextToSpans(titleElement);
        titleElement.style.animation = 'gradientShift 4s ease infinite';
        createSparkles();
        
        // Add hover effect for letters
        const letters = titleElement.querySelectorAll('span');
        letters.forEach((letter) => {
            letter.addEventListener('mouseenter', () => {
                letter.style.transform = 'translateY(-10px) scale(1.2)';
                letter.style.transition = 'transform 0.3s ease';
            });
            
            letter.addEventListener('mouseleave', () => {
                letter.style.transform = 'translateY(0) scale(1)';
            });
        });
    }
});

// Global state to track current filters
let currentFilters = {
    query: '<%= searchQuery || "" %>',
    category: '<%= selectedCategory || "" %>',
    minPrice: '<%= minPrice || "" %>',
    maxPrice: '<%= maxPrice || "" %>',
    alpha: '<%= alphaFilter || "" %>',
    sort: '<%= sort || "relevance" %>',
    page: <%= currentPage || 1 %>
};

function debounce(func, delay) {
    let timeoutId;
    return function (...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
    };
}

function showLoading() {
    const productGrid = document.getElementById('product-grid');
    productGrid.innerHTML = '<div class="loading">Loading products...</div>';
}

function updateActiveCategory() {
    
    document.querySelectorAll('.category-link').forEach(link => {
        link.classList.remove('active');
    });
    
    
    const activeLink = document.querySelector(`[data-category="${currentFilters.category}"]`);
    if (activeLink) {
        activeLink.classList.add('active');
    }
}

function performSearch(resetPage = true) {
    if (resetPage) {
        currentFilters.page = 1;
    }
    
    showLoading();
    updateActiveCategory();
    
    const queryParams = new URLSearchParams();
    
    // Only add non-empty parameters
    Object.keys(currentFilters).forEach(key => {
        if (currentFilters[key] && currentFilters[key] !== '') {
            queryParams.append(key, currentFilters[key]);
        }
    });

    fetch(`/filter?${queryParams.toString()}`, {
        headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        updateProductGrid(data);
        updatePagination(data);
        updateProductsFound(data);
        
        // Update URL without page reload
        const newUrl = `/shop?${queryParams.toString()}`;
        window.history.pushState(currentFilters, '', newUrl);
    })
    .catch(error => {
        console.error('Error fetching products:', error);
        const productGrid = document.getElementById('product-grid');
        productGrid.innerHTML = `
            <p style="text-align: center; color: var(--light-text); font-size: 18px;">
                Error loading products. Please try again.
            </p>
        `;
    });
}

function updateProductGrid(data) {
    const productGrid = document.getElementById('product-grid');
    productGrid.innerHTML = '';
    
    if (data.products && data.products.length > 0) {
        data.products.forEach(product => {
            const productCard = document.createElement('div');
            productCard.className = 'product-card';

            //  price display
            const priceHTML = product.regularPrice !== product.salePrice
                ? `<span style="display: flex; gap: 10px; align-items: center;">
                     <del><p class="product-price">₹ ${product.regularPrice}</p></del>
                     <p class="product-price">₹ ${product.salePrice}</p>
                   </span>`
                : `<span style="display: flex; gap: 10px; align-items: center;">
                     <p class="product-price">₹ ${product.salePrice}</p>
                   </span>`;

            const userWishlist = <%= user && user.wishlist ? JSON.stringify(user.wishlist.map(w => String(w.id))) : '[]' %>;

            productCard.innerHTML = `
                <div class="product-image">
                    <img src="/${product.productImage[0]}" alt="${product.productName}">
                    ${product.quantity === 0 ? '<div class="out-of-stock-badge">Out of Stock</div>' : ''}
                </div>
                <div class="product-details">
                    <h3 class="product-name">${product.productName}</h3>
                    <p class="product-brand">Brand: ${product.brand}</p>
                    ${priceHTML}
                    <p class="product-color">Color: ${product.color}</p>
                    <p class="product-description">${product.description.slice(0, 100)}...</p>
                    ${product.quantity > 0 
                        ? `<a href="/product/${product._id}" class="view-button">View Product</a>`
                        : `<a href="/product/${product._id}" class="view-button disabled-btn" style="background:#ccc;color:#666;opacity:0.7;cursor:not-allowed;pointer-events:none;">Out of Stock</a>`
                    }
                    <a class="wishlist-btn" onclick="addToWishlist('${product._id}')">
                        <i class="fa-solid fa-heart ${userWishlist.includes(product._id) ? 'wishlist-active' : ''}"></i>
                    </a>
                </div>
            `;

            productGrid.appendChild(productCard);
        });
    } else {
        productGrid.innerHTML = `
            <p style="text-align: center; color: var(--light-text); font-size: 18px;">
                No products found. Try adjusting your filters.
            </p>
        `;
    }
}

function updatePagination(data) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    if (data.totalPages > 1) {
        // Previous button
        if (data.currentPage > 1) {
            const prevLink = document.createElement('a');
            prevLink.textContent = '‹ Previous';
            prevLink.onclick = () => goToPage(data.currentPage - 1);
            pagination.appendChild(prevLink);
        }
        
        // Page numbers
        const startPage = Math.max(1, data.currentPage - 2);
        const endPage = Math.min(data.totalPages, data.currentPage + 2);
        
        if (startPage > 1) {
            const firstLink = document.createElement('a');
            firstLink.textContent = '1';
            firstLink.onclick = () => goToPage(1);
            pagination.appendChild(firstLink);
            
            if (startPage > 2) {
                const dots = document.createElement('span');
                dots.textContent = '...';
                dots.style.padding = '8px 12px';
                pagination.appendChild(dots);
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageLink = document.createElement('a');
            pageLink.textContent = i;
            pageLink.className = data.currentPage === i ? 'active' : '';
            pageLink.onclick = () => goToPage(i);
            pagination.appendChild(pageLink);
        }
        
        if (endPage < data.totalPages) {
            if (endPage < data.totalPages - 1) {
                const dots = document.createElement('span');
                dots.textContent = '...';
                dots.style.padding = '8px 12px';
                pagination.appendChild(dots);
            }
            
            const lastLink = document.createElement('a');
            lastLink.textContent = data.totalPages;
            lastLink.onclick = () => goToPage(data.totalPages);
            pagination.appendChild(lastLink);
        }
        
        // Next button
        if (data.currentPage < data.totalPages) {
            const nextLink = document.createElement('a');
            nextLink.textContent = 'Next ›';
            nextLink.onclick = () => goToPage(data.currentPage + 1);
            pagination.appendChild(nextLink);
        }
    }
}

// Wishlist
async function addToWishlist(productId) {
    try {
        const response = await fetch(`/addToWishlist/${productId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Added to Wishlist!',
                text: 'Product has been added to your wishlist.',
                confirmButtonColor: '#d4af37',
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Failed to Add!',
                text: data.message || 'Failed to add product to wishlist.',
                confirmButtonColor: '#d4af37',
            });
        }
    } catch (error) {
        console.error('Error adding to wishlist:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: 'Please login to add to wishlist.',
            confirmButtonColor: '#d4af37',
        });
    }
}

function updateProductsFound(data) {
    const productsFound = document.getElementById('products-found');
    const start = (data.currentPage - 1) * 9 + 1;
    const end = Math.min(data.currentPage * 9, data.totalProducts);
    productsFound.textContent = `Showing ${start}-${end} of ${data.totalProducts} products`;
}

function goToPage(page) {
    currentFilters.page = page;
    performSearch(false);
}

function filterByCategory(categoryId) {
    currentFilters.category = categoryId;
    performSearch();
}

function applyPriceFilter() {
    const minPrice = document.getElementById('minPriceInput').value;
    const maxPrice = document.getElementById('maxPriceInput').value;
    
    currentFilters.minPrice = minPrice;
    currentFilters.maxPrice = maxPrice;
    performSearch();
}

function resetAllFilters() {
    currentFilters = {
        query: '',
        category: '',
        minPrice: '',
        maxPrice: '',
        alpha: '',
        sort: 'relevance',
        page: 1
    };
    
    // Reset form inputs
    document.getElementById('search-input').value = '';
    document.getElementById('minPriceInput').value = '';
    document.getElementById('maxPriceInput').value = '';
    document.getElementById('sort-select').value = 'relevance';
    
    // Reset alpha filter
    document.querySelectorAll('.alpha-checkbox').forEach(checkbox => {
        checkbox.checked = checkbox.value === '';
    });
    
    performSearch();
}


document.addEventListener('DOMContentLoaded', function() {
    // Search input with debounce
    const searchInput = document.getElementById('search-input');
    const debouncedSearch = debounce(() => {
        currentFilters.query = searchInput.value.trim();
        performSearch();
    }, 300);
    searchInput.addEventListener('input', debouncedSearch);

    // Search form submission
    document.getElementById('search-form').addEventListener('submit', (e) => {
        e.preventDefault();
        currentFilters.query = searchInput.value.trim();
        performSearch();
    });

    // Sort select change
    document.getElementById('sort-select').addEventListener('change', (e) => {
        currentFilters.sort = e.target.value;
        performSearch();
    });

    // Alpha filter change
    document.querySelectorAll('.alpha-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            if (checkbox.checked) {
                currentFilters.alpha = checkbox.value;
                performSearch();
            }
        });
    });

    // Price input changes
    document.getElementById('minPriceInput').addEventListener('change', () => {
        currentFilters.minPrice = document.getElementById('minPriceInput').value;
        performSearch();
    });

    document.getElementById('maxPriceInput').addEventListener('change', () => {
        currentFilters.maxPrice = document.getElementById('maxPriceInput').value;
        performSearch();
    });

    // Initialize pagination for current page
    const initialData = {
        currentPage: <%= currentPage || 1 %>,
        totalPages: <%= totalPages || 1 %>,
        totalProducts: <%= totalProducts || 0 %>
    };
    updatePagination(initialData);
    updateActiveCategory();
});

window.addEventListener('popstate', function(event) {
    if (event.state) {
        currentFilters = event.state;
        
        // Update form inputs to match state
        document.getElementById('search-input').value = currentFilters.query || '';
        document.getElementById('minPriceInput').value = currentFilters.minPrice || '';
        document.getElementById('maxPriceInput').value = currentFilters.maxPrice || '';
        document.getElementById('sort-select').value = currentFilters.sort || 'relevance';
        
        // Update alpha filter
        document.querySelectorAll('.alpha-checkbox').forEach(checkbox => {
            checkbox.checked = checkbox.value === (currentFilters.alpha || '');
        });
        
        performSearch(false);
    }
});
</script>

<%- include("../../views/partials/user/footer") %>