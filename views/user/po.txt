signup.ejs

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <title>Sign Up | SAWAX Premium Timepieces</title>
    <style>
        :root {
            --primary: #1a1a1a;
            --secondary: #f8f8f8;
            --accent: #d4af37;
            --text: #333;
            --light-text: #777;
            --border: #e0e0e0;
            --error: #dc3545;
            --success: #28a745;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            color: var(--text);
            overflow-x: hidden;
            background: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(135deg, rgba(212, 175, 55, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 20% 30%, rgba(212, 175, 55, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(255, 215, 0, 0.04) 0%, transparent 40%),
                linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
            z-index: 0;
        }

        
        .stripe-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 100px,
                rgba(212, 175, 55, 0.04) 100px,
                rgba(212, 175, 55, 0.04) 102px
            );
            z-index: 1;
            pointer-events: none;
        }

        
        .spotlight {
            position: fixed;
            width: 600px;
            height: 600px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1;
            opacity: 0.1;
            filter: blur(100px);
            animation: spotlightMove 20s ease-in-out infinite;
        }

        .spotlight-1 {
            background: radial-gradient(circle, rgba(212, 175, 55, 0.4), transparent 70%);
            top: -200px;
            left: -200px;
            animation-delay: 0s;
        }

        .spotlight-2 {
            background: radial-gradient(circle, rgba(255, 215, 0, 0.35), transparent 70%);
            bottom: -200px;
            right: -200px;
            animation-delay: -10s;
        }

        @keyframes spotlightMove {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(50px, -30px) scale(1.1); }
            50% { transform: translate(-30px, 50px) scale(0.95); }
            75% { transform: translate(40px, 40px) scale(1.05); }
        }

        
        .display-case {
            position: fixed;
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.05), transparent);
            pointer-events: none;
            z-index: 1;
            animation: floatCase 25s ease-in-out infinite;
        }

        .case-1 {
            width: 200px;
            height: 150px;
            top: 10%;
            right: 5%;
            animation-delay: 0s;
        }

        .case-2 {
            width: 180px;
            height: 130px;
            bottom: 15%;
            left: 8%;
            animation-delay: -8s;
        }

        .case-3 {
            width: 160px;
            height: 120px;
            top: 60%;
            right: 10%;
            animation-delay: -15s;
        }

        @keyframes floatCase {
            0%, 100% { 
                transform: translateY(0) rotate(0deg); 
                opacity: 0.4;
            }
            25% { 
                transform: translateY(-20px) rotate(1deg); 
                opacity: 0.6;
            }
            50% { 
                transform: translateY(0) rotate(-1deg); 
                opacity: 0.5;
            }
            75% { 
                transform: translateY(-15px) rotate(0.5deg); 
                opacity: 0.55;
            }
        }

        
        .shimmer {
            position: fixed;
            width: 3px;
            height: 3px;
            background: rgba(212, 175, 55, 0.7);
            border-radius: 50%;
            pointer-events: none;
            z-index: 1;
            box-shadow: 0 0 8px rgba(212, 175, 55, 0.5);
            animation: shimmerFloat 15s ease-in-out infinite;
        }

        @keyframes shimmerFloat {
            0% { 
                transform: translate(0, 0) scale(0.5); 
                opacity: 0;
            }
            10% { opacity: 0.6; }
            50% { 
                transform: translate(var(--x), var(--y)) scale(1.2); 
                opacity: 0.8;
            }
            90% { opacity: 0.5; }
            100% { 
                transform: translate(calc(var(--x) * 2), calc(var(--y) * 2)) scale(0.5); 
                opacity: 0;
            }
        }

        
        .time-marker {
            position: fixed;
            width: 2px;
            height: 20px;
            background: linear-gradient(to bottom, transparent, rgba(212, 175, 55, 0.4), transparent);
            pointer-events: none;
            z-index: 1;
            animation: markerPulse 4s ease-in-out infinite;
        }

        .marker-12 { top: 5%; left: 50%; transform: translateX(-50%); animation-delay: 0s; }
        .marker-3 { top: 50%; right: 5%; transform: translateY(-50%) rotate(90deg); animation-delay: 1s; }
        .marker-6 { bottom: 5%; left: 50%; transform: translateX(-50%); animation-delay: 2s; }
        .marker-9 { top: 50%; left: 5%; transform: translateY(-50%) rotate(90deg); animation-delay: 3s; }

        @keyframes markerPulse {
            0%, 100% { opacity: 0.4; height: 20px; }
            50% { opacity: 0.7; height: 30px; }
        }

       
        .glass-reflection {
            position: fixed;
            width: 300px;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(212, 175, 55, 0.2), 
                transparent);
            pointer-events: none;
            z-index: 2;
            animation: glassShine 8s ease-in-out infinite;
        }

        .reflection-1 {
            top: 20%;
            left: -300px;
            transform: rotate(-45deg);
            animation-delay: 0s;
        }

        .reflection-2 {
            top: 70%;
            right: -300px;
            transform: rotate(45deg);
            animation-delay: 4s;
        }

        @keyframes glassShine {
            0%, 100% { transform: translateX(0) rotate(-45deg); opacity: 0; }
            10% { opacity: 0.6; }
            50% { transform: translateX(calc(100vw + 300px)) rotate(-45deg); opacity: 0.8; }
            90% { opacity: 0.4; }
        }

       
        .sparkle {
            position: fixed;
            width: 4px;
            height: 4px;
            pointer-events: none;
            z-index: 2;
            animation: sparkleEffect 3s ease-in-out infinite;
        }

        .sparkle::before,
        .sparkle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 1px;
            background: rgba(212, 175, 55, 0.7);
            transform: translate(-50%, -50%);
        }

        .sparkle::after {
            transform: translate(-50%, -50%) rotate(90deg);
        }

        @keyframes sparkleEffect {
            0%, 100% { opacity: 0; transform: scale(0.5) rotate(0deg); }
            50% { opacity: 1; transform: scale(1.5) rotate(180deg); }
        }

        header, .signup-section, footer {
            position: relative;
            z-index: 10;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .header-content {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
        }

        .logo {
            display: inline-block;
            font-family: "Poppins", sans-serif;
            font-size: 2.2rem;
            font-weight: 700;
            color: #f4d03f;
            cursor: pointer;
            transition: transform 0.3s ease, text-shadow 0.3s ease;
        }

        .logo span {
            color: #f4d03f;
        }

        .logo:hover {
            transform: scale(1.08);
            text-shadow: 0 0 12px rgba(212, 175, 55, 0.4);
        }

        .signup-section {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px 0;
        }

        .signup-container {
            width: 100%;
            max-width: 520px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08),
                        0 2px 8px rgba(212, 175, 55, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
            position: relative;
        }

        .signup-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(212, 175, 55, 0.08), 
                transparent);
            animation: containerShine 6s ease-in-out infinite;
        }

        @keyframes containerShine {
            0%, 100% { left: -100%; }
            50% { left: 100%; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .signup-header {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.08) 0%, rgba(255, 255, 255, 0.95) 100%);
            color: #1a1a1a;
            padding: 30px;
            text-align: center;
            position: relative;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }

        .signup-header h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #1a1a1a;
        }

        .signup-header p {
            font-size: 14px;
            opacity: 0.7;
            color: #333;
        }

        .signup-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 2px;
            background: linear-gradient(90deg, transparent, #d4af37, transparent);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        .signup-form {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: #1a1a1a;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(212, 175, 55, 0.25);
            background: rgba(255, 255, 255, 0.8);
            color: #1a1a1a;
            border-radius: 4px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.15);
        }

        .form-control::placeholder {
            color: rgba(0, 0, 0, 0.35);
        }

        .form-error {
            display: none;
        }

        .error-message {
            color: var(--error);
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .referral-info {
            margin-top: 5px;
        }

        .referral-info small {
            color: var(--light-text);
        }

        .referral-validation {
            margin-top: 5px;
            font-size: 14px;
            font-weight: 500;
        }

        .referral-validation.valid {
            color: var(--success);
        }

        .referral-validation.invalid {
            color: var(--error);
        }

        .terms-agreement {
            font-size: 13px;
            color: var(--light-text);
            margin-bottom: 20px;
            text-align: center;
        }

        .terms-agreement a {
            color: var(--accent);
            text-decoration: none;
            transition: color 0.3s;
        }

        .terms-agreement a:hover {
            color: #b8860b;
        }

        .btn {
            display: inline-block;
            width: 100%;
            padding: 8px;
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 50%, #d4af37 100%);
            background-size: 200% 100%;
            color: #ffffff;
            font-weight: 600;
            border-radius: 4px;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 14px;
            text-align: center;
            position: relative;
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.25);
        }

        .btn:hover {
            background-position: 100% 0;
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(212, 175, 55, 0.35);
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .btn.loading .spinner {
            display: inline-block;
        }

        .signup-divider {
            display: flex;
            align-items: center;
            margin: 25px 0;
            color: #999;
            font-size: 14px;
        }

        .signup-divider::before,
        .signup-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.3), transparent);
        }

        .signup-divider span {
            padding: 0 15px;
        }

        .social-signup {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .social-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(212, 175, 55, 0.25);
            transition: all 0.3s;
            cursor: pointer;
            text-decoration: none;
            color: #1a1a1a;
        }

        .social-btn:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: var(--accent);
        }

        .social-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .signup-footer {
            text-align: center;
            margin-top: 25px;
            font-size: 14px;
            color: #666;
        }

        .signin-link {
            color: var(--accent);
            font-weight: 600;
            transition: color 0.3s;
            text-decoration: none;
        }

        .signin-link:hover {
            color: #b8860b;
        }

        footer {
            background-color: rgba(250, 250, 250, 0.95);
            backdrop-filter: blur(10px);
            color: #333;
            padding: 20px 0;
            font-size: 14px;
            border-top: 1px solid rgba(212, 175, 55, 0.1);
        }

        .footer-simplified {
            display: flex;
            justify-content: space-between;
            align-items: center;
            opacity: 0.8;
        }

        .footer-links {
            display: flex;
            gap: 20px;
        }

        .footer-link {
            transition: color 0.3s;
            color: #333;
            text-decoration: none;
        }

        .footer-link:hover {
            color: var(--accent);
        }

        @media (max-width: 768px) {
            .signup-container {
                max-width: 100%;
                margin: 0 20px;
            }
            
            .signup-section {
                padding: 40px 0;
            }
            
            .social-signup {
                flex-direction: column;
            }
            
            .footer-simplified {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .logo {
                font-size: 28px;
            }
        }

        @media (max-width: 576px) {
            .signup-header {
                padding: 20px;
            }
            
            .signup-form {
                padding: 20px;
            }

            .logo {
                font-size: 24px;
            }

            .header-content {
                padding: 15px 0;
            }
        }
    </style>
</head>
<body>
    
    <div class="stripe-pattern"></div>
    <div class="spotlight spotlight-1"></div>
    <div class="spotlight spotlight-2"></div>
    
    <div class="display-case case-1"></div>
    <div class="display-case case-2"></div>
    <div class="display-case case-3"></div>
    
    <div class="time-marker marker-12"></div>
    <div class="time-marker marker-3"></div>
    <div class="time-marker marker-6"></div>
    <div class="time-marker marker-9"></div>
    
    <div class="glass-reflection reflection-1"></div>
    <div class="glass-reflection reflection-2"></div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">SA<span>WAX</span></div>
            </div>
        </div>
    </header>

    <section class="signup-section">
        <div class="signup-container">
            <div class="signup-header">
                <h2>Create Account</h2>
                <p>Join the SAWAX community and choose your best</p>
            </div>
            <div class="signup-form">
                <form id="signupform" action="/signup" method="post">
                    <div class="form-group">
                        <label for="name">Full Name</label>
                        <input type="text" id="name" class="form-control" name="name" placeholder="Enter your full name" required>
                        <div class="form-error">Please enter your full name</div>
                        <div id="error1" class="error-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" name="email" class="form-control" placeholder="Enter your email" required>
                        <div class="form-error">Please enter a valid email address</div>
                        <div id="error2" class="error-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <div class="input-group">
                            <input type="password" id="password" name="password" class="form-control" placeholder="Create a password" required>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary toggle-password" type="button" id="togglePassword">
                                    <span class="eye-icon">üëÅ</span>
                                </button>
                            </div>
                        </div>
                        <div class="form-error">Password must be at least 8 characters</div>
                        <div id="error3" class="error-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">Confirm Password</label>
                        <div class="input-group">
                            <input type="password" id="confirm-password" name="cPassword" class="form-control" placeholder="Confirm your password" required>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary toggle-password" type="button" id="toggleConfirmPassword">
                                    <span class="eye-icon">üëÅ</span>
                                </button>
                            </div>
                        </div>
                        <div class="form-error">Passwords do not match</div>
                        <div id="error4" class="error-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="referralCode">Referral Code (Optional)</label>
                        <input type="text" id="referralCode" name="referralCode" class="form-control" placeholder="Enter referral code to get ‚Çπ50 bonus" >
                        <div class="referral-info">
                            <small class="text-muted">üéÅ Get ‚Çπ50 joining bonus with a valid referral code!</small>
                        </div>
                        <div id="referralValidation" class="referral-validation"></div>
                        <div id="error5" class="error-message"></div>
                    </div>

                    <div class="terms-agreement">
                        By creating an account, you agree to our <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a>.
                    </div>
                    
                    <button type="submit" class="btn">
                        Create Account
                        <span class="spinner"></span>
                    </button>
                </form>
                
                <div class="signup-divider">
                    <span>OR</span>
                </div>
                
                <div class="social-signup">
                    <a href="/auth/google" class="social-btn">
                        <span class="social-icon">G</span>
                        Sign up with Google
                    </a>
                </div>
                
                <div class="signup-footer">
                    Already have an account? <a href='/login' class="signin-link">Sign in</a>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <div class="container">
            <div class="footer-simplified">
                <div>¬© 2025 SAWAX. All rights reserved.</div>
                <div class="footer-links">
                    <a href="#" class="footer-link">Privacy Policy</a>
                    <a href="#" class="footer-link">Terms of Service</a>
                    <a href="#" class="footer-link">Help Center</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        
        function createShimmers() {
            const shimmerCount = 25;
            for (let i = 0; i < shimmerCount; i++) {
                const shimmer = document.createElement('div');
                shimmer.className = 'shimmer';
                shimmer.style.left = Math.random() * 100 + '%';
                shimmer.style.top = Math.random() * 100 + '%';
                shimmer.style.setProperty('--x', (Math.random() - 0.5) * 200 + 'px');
                shimmer.style.setProperty('--y', (Math.random() - 0.5) * 200 + 'px');
                shimmer.style.animationDelay = Math.random() * 15 + 's';
                shimmer.style.animationDuration = (12 + Math.random() * 8) + 's';
                document.body.appendChild(shimmer);
            }
        }

        // Create diamond sparkles
        function createSparkles() {
            const sparkleCount = 15;
            for (let i = 0; i < sparkleCount; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = Math.random() * 100 + '%';
                sparkle.style.top = Math.random() * 100 + '%';
                sparkle.style.animationDelay = Math.random() * 3 + 's';
                sparkle.style.animationDuration = (2 + Math.random() * 2) + 's';
                document.body.appendChild(sparkle);
            }
        }

        createShimmers();
        createSparkles();

        const nameid = document.getElementById("name");
        const emailid = document.getElementById("email");
        const passid = document.getElementById("password");
        const cpassid = document.getElementById("confirm-password");
        const referralCodeid = document.getElementById("referralCode");
        const error1 = document.getElementById("error1");
        const error2 = document.getElementById("error2");
        const error3 = document.getElementById("error3");
        const error4 = document.getElementById("error4");
        const error5 = document.getElementById("error5");
        const referralValidation = document.getElementById("referralValidation");
        const signupform = document.getElementById("signupform");
        const signupButton = document.querySelector(".btn");
        const spinner = document.querySelector(".spinner");

        if (!nameid || !emailid || !passid || !cpassid || !error1 || !error2 || !error3 || !error4 ||  !signupform || !signupButton || !spinner) {
            console.error("One or more DOM elements not found");
            throw new Error("Required DOM elements missing");
        }

        function nameValidateChecking() {
            const nameval = nameid.value.trim();
            const namepattern = /^[A-Za-z\s]+$/;

            if (!nameval) {
                error1.style.display = "block";
                error1.innerHTML = "Please enter your full name";
                return false;
            } else if (!namepattern.test(nameval)) {
                error1.style.display = "block";
                error1.innerHTML = "Name can only contain letters and spaces";
                return false;
            } else {
                error1.style.display = "none";
                error1.innerHTML = "";
                return true;
            }
        }

        function emailValidateChecking() {
            const emailval = emailid.value;
            const emailpattern = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

            if (!emailval) {
                error2.style.display = "block";
                error2.innerHTML = "Please enter an email address";
                return false;
            } else if (!emailpattern.test(emailval)) {
                error2.style.display = "block";
                error2.innerHTML = "Invalid email format";
                return false;
            } else {
                error2.style.display = "none";
                error2.innerHTML = "";
                return true;
            }
        }

        function passValidateChecking() {
            const passval = passid.value;
            const cpassval = cpassid.value;
            const alpha = /[a-zA-Z]/;
            const digit = /\d/;
            const capital = /[A-Z]/;

            if (!passval) {
                error3.style.display = "block";
                error3.innerHTML = "Please enter a password";
                return false;
            } else if (passval.length < 8) {
                error3.style.display = "block";
                error3.innerHTML = "Password must be at least 8 characters";
                return false;
            } else if (!alpha.test(passval) || !digit.test(passval) || !capital.test(passval)) {
                error3.style.display = "block";
                error3.innerHTML = "Password must contain letters, numbers, and at least one capital letter";
                return false;
            } else {
                error3.style.display = "none";
                error3.innerHTML = "";
            }

            if (!cpassval) {
                error4.style.display = "block";
                error4.innerHTML = "Please confirm your password";
                return false;
            } else if (passval !== cpassval) {
                error4.style.display = "block";
                error4.innerHTML = "Passwords do not match";
                return false;
            } else {
                error4.style.display = "none";
                error4.innerHTML = "";
                return true;
            }
        }

        function validateReferralCode() {
            const referralCode = referralCodeid.value.trim();
            
            if (!referralCode) {
                referralValidation.innerHTML = "";
                referralValidation.className = "referral-validation";
                return true; 
            }

            referralValidation.innerHTML = '<span style="color: #666;">Checking referral code...</span>';
            
            fetch('/validate-referral', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ referralCode: referralCode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    referralValidation.innerHTML = `<span style="color: #28a745;">‚úì ${data.message}</span>`;
                    referralValidation.className = "referral-validation valid";
                } else {
                    referralValidation.innerHTML = `<span style="color: #dc3545;">‚úó ${data.message}</span>`;
                    referralValidation.className = "referral-validation invalid";
                }
            })
            .catch(error => {
                console.error('Error:', error);
                referralValidation.innerHTML = '<span style="color: #dc3545;">Error validating referral code</span>';
                referralValidation.className = "referral-validation invalid";
            });
        }

        nameid.addEventListener("input", nameValidateChecking);
        emailid.addEventListener("input", emailValidateChecking);
        passid.addEventListener("input", passValidateChecking);
        cpassid.addEventListener("input", passValidateChecking);
        
        let referralTimeout;
        referralCodeid.addEventListener("input", function() {
            clearTimeout(referralTimeout);
            referralTimeout = setTimeout(validateReferralCode, 500); 
        });

        // Password toggle functionality
        const togglePassword = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('password');
        if (togglePassword && passwordInput) {
            togglePassword.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                const eyeIcon = this.querySelector('.eye-icon');
                eyeIcon.textContent = type === 'password' ? 'üëÅ' : 'üëÅ';
            });
        }

        const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
        const confirmPasswordInput = document.getElementById('confirm-password');
        if (toggleConfirmPassword && confirmPasswordInput) {
            toggleConfirmPassword.addEventListener('click', function() {
                const type = confirmPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                confirmPasswordInput.setAttribute('type', type);
                const eyeIcon = this.querySelector('.eye-icon');
                eyeIcon.textContent = type === 'password' ? 'üëÅ' : 'üëÅ';
            });
        }

        signupform.addEventListener("submit", function(e) {
            const isNameValid = nameValidateChecking();
            const isEmailValid = emailValidateChecking();
            const isPassValid = passValidateChecking();
            
            const referralValidationClass = referralValidation.className;
            if (referralCodeid.value.trim() && referralValidationClass.includes('invalid')) {
                e.preventDefault();
                error5.style.display = "block";
                error5.innerHTML = "Please enter a valid referral code or leave it empty";
                return;
            } else {
                error5.style.display = "none";
                error5.innerHTML = "";
            }

            if (!isNameValid || !isEmailValid || !isPassValid) {
                e.preventDefault();
            } else {
                signupButton.disabled = true;
                signupButton.classList.add("loading");

                const handleFormCompletion = () => {
                    signupButton.disabled = false;
                    signupButton.classList.remove("loading");
                };

                setTimeout(handleFormCompletion, 3000);
            }
        });
    </script>
</body>
</html>


userController.js

const User = require('../../models/userSchema');
const Category = require("../../models/categorySchema");
const Product = require("../../models/productSchema")
const Wallet = require("../../models/walletSchema");
const env = require('dotenv').config();
const nodemailer = require('nodemailer');
const bcrypt = require('bcrypt');
const brand = require('../../models/brandSchema');
const wishlist = require('../../models/userSchema');
const mongoose = require('mongoose');
const path = require("path");
const crypto = require("crypto");
const Cart = require("../../models/cartSchema");

const pageNotFound = async (req, res) => {
    try {
        res.render('page-404')
    } catch (error) {
        res.redirect('/pagenotfound')
    }
}

const loadHomePage = async (req, res) => {
    try {
        const user = req.session.user
        const userData = await User.findOne({_id:user})
        const products = await Product.find({isBlocked:0}).limit(8).populate('category').sort({createdAt:-1})

        if(user){
            res.render("home",{user:userData,products})
            console.log(userData);
        }else{
            res.render('home',{
                user:userData,
                products:products
            })
        }
    } catch (error) {
        console.log('Home Page Not Found')
        res.status(500).send('Server Error')
    }
}

const loadSignUpPage = async (req, res) => {
    try {
        res.render('signup')
    } catch (error) {
        console.log('Sign Up Page Not Found')
        res.status(500).send('Server Error')
    }
}

// Render the forgot password page (GET /forgot-password)
const renderForgotPassword = (req, res) => {
  res.render('forgot-password', { message: '' });
};


const forgotPassword = async (req, res) => {
  try {
    const { email } = req.body;
    const user = await User.findOne({ email });
    console.log(email, user);
    if (!user) {
      return res.render('forgot-password', { message: 'Email not found.' });
    }

    const otp = Math.floor(100000 + Math.random() * 900000).toString();
    req.session.forgotPasswordOtp = otp;
    req.session.forgotPasswordEmail = email;

    const emailSent = await sendVerificationEmail(email, otp);
    if (!emailSent) {
      return res.render('forgot-password', { message: 'Failed to send OTP. Please try again.' });
    }

    res.redirect('/otp-verification2');
  } catch (error) {
    console.error('Error in forgotPassword:', error);
    res.status(500).render('forgot-password', { message: 'Server Error' });
  }
};

// Render OTP verification page for forgot password
const renderForgotPasswordOtp = async (req, res) => {
    try {
        if (req.session.user) {
            return res.redirect('/');
        }
        res.render('otp-verification2');
    } catch (error) {
        res.redirect('/pagenotfound');
    }
};

// Verify forgot password OTP
const verifyForgotPasswordOtp = async (req, res) => {
    try {
        const { otp1, otp2, otp3, otp4, otp5, otp6 } = req.body;
        const otp = otp1.concat(otp2).concat(otp3).concat(otp4).concat(otp5).concat(otp6);
        
        if (otp === req.session.forgotPasswordOtp) {
            req.session.otpVerified = true;
            res.json({ success: true, message: 'OTP verified successfully' });
        } else {
            res.status(400).json({ success: false, message: 'Invalid OTP. Please try again.' });
        }
    } catch (error) {
        console.error('Error verifying forgot password OTP:', error);
        res.status(500).json({ success: false, message: 'Server Error' });
    }
};

// Resend forgot password OTP
const resendForgotPasswordOtp = async (req, res) => {
    try {
        const email = req.session.forgotPasswordEmail;
        if (!email) {
            return res.status(400).json({ success: false, message: 'Session expired. Please start over.' });
        }

        const otp = Math.floor(100000 + Math.random() * 900000).toString();
        req.session.forgotPasswordOtp = otp;

        const emailSent = await sendVerificationEmail(email, otp);
        if (emailSent) {
            res.json({ success: true, message: 'OTP sent successfully' });
        } else {
            res.status(500).json({ success: false, message: 'Failed to send OTP. Please try again.' });
        }
    } catch (error) {
        console.error('Error resending forgot password OTP:', error);
        res.status(500).json({ success: false, message: 'Server Error' });
    }
};

// Render reset password page
const renderResetPassword = async (req, res) => {
    try {
        if (!req.session.otpVerified) {
            return res.redirect('/forgot-password');
        }
        res.render('reset-password');
    } catch (error) {
        res.redirect('/pagenotfound');
    }
};


const resetPassword = async (req, res) => {
  try {
    const { password } = req.body;
    const email = req.session.forgotPasswordEmail;

    if (!email || !req.session.otpVerified) {
      return res.status(400).json({ status: false, message: 'Session expired. Please start over.' });
    }

    // password validation
    const minLength = password.length >= 8;
    const hasUpperCase = /[A-Z]/.test(password);
    const hasNumber = /[0-9]/.test(password);

    if (!minLength || !hasUpperCase || !hasNumber) {
      const errors = [];
      if (!minLength) errors.push('Password must be at least 8 characters');
      if (!hasUpperCase) errors.push('Password must include at least one capital letter');
      if (!hasNumber) errors.push('Password must include at least one number');
      return res.status(400).json({ status: false, message: errors.join(', ') });
    }

    const hashedPassword = await bcrypt.hash(password, 10);
    await User.findOneAndUpdate({ email }, { password: hashedPassword });

    // Clear session data
    req.session.forgotPasswordEmail = null;
    req.session.forgotPasswordOtp = null;
    req.session.otpVerified = null;

    res.json({ status: true, message: 'Password updated successfully.' });
  } catch (error) {
    console.error('Error in resetPassword:', error);
    res.status(500).json({ status: false, message: 'Server Error' });
  }
};

function generateOTP() {
    return Math.floor(100000 + Math.random() * 900000).toString();
}

async function sendVerificationEmail(email, otp) {
  try {
      console.log("=== SENDING EMAIL START ===");
      console.log("Target Email:", email);
      console.log("OTP:", otp);
      console.log("From:", process.env.NODEMAILER_EMAIL);

      if (!email) {
          console.error("No email provided.");
          return false;
      }

      const transporter = nodemailer.createTransport({
    service: 'gmail',
    auth: {
        user: process.env.NODEMAILER_EMAIL,
        pass: process.env.NODEMAILER_PASSWORD
    }
});


// console.log(process.env.NODEMAILER_EMAIL);
// console.log(process.env.NODEMAILER_PASSWORD);





      const info = await transporter.sendMail({
          from: process.env.NODEMAILER_EMAIL,
          to: email,
          subject: 'OTP for Verification',
          text: `Your OTP is ${otp}`,
          html: `<b>Your OTP is ${otp}</b>`
      });

      console.log("Email sent successfully:", info.response);
      return info.accepted.length > 0;

  } catch (error) {
      console.error("Error sending email:", error);
      return false;
  }
}

// process referral bonuses
const processReferralBonus = async (newUser, referrerCode) => {
    try {
        if (!referrerCode) return;

        // Find the referrer by their referral code
        const referrer = await User.findOne({ referId: referrerCode });
        if (!referrer) {
            console.log('Invalid referral code:', referrerCode);
            return;
        }

        // Don't allow self-referral
        if (referrer._id.toString() === newUser._id.toString()) {
            console.log('Self-referral attempted');
            return;
        }

        // Create or update referrer's wallet
        let referrerWallet = await Wallet.findOne({ userId: referrer._id });
        if (!referrerWallet) {
            referrerWallet = new Wallet({
                userId: referrer._id,
                balance: 0,
                refundAmount: 0,
                totalDebited: 0,
                transactions: []
            });
        }

        // Create or update new user wallet
        let newUserWallet = await Wallet.findOne({ userId: newUser._id });
        if (!newUserWallet) {
            newUserWallet = new Wallet({
                userId: newUser._id,
                balance: 0,
                refundAmount: 0,
                totalDebited: 0,
                transactions: []
            });
        }

        // Add referral bonus to referrer ‚Çπ100
        const referralBonus = 100;
        referrerWallet.balance += referralBonus;
        referrerWallet.transactions.push({
            amount: referralBonus,
            type: 'credit',
            description: `Referral bonus for inviting ${newUser.name}`,
            transactionPurpose: 'referral_bonus',
            referenceId: `REF_${newUser._id}`,
            status: 'COMPLETED',
            date: new Date()
        });

        // Add joining bonus to new user ‚Çπ50
        const joiningBonus = 50;
        newUserWallet.balance += joiningBonus;
        newUserWallet.transactions.push({
            amount: joiningBonus,
            type: 'credit',
            description: `Welcome bonus for joining SAWAX`,
            transactionPurpose: 'joining_bonus',
            referenceId: `JOIN_${newUser._id}`,
            status: 'COMPLETED',
            date: new Date()
        });

        // Update user documents
        referrer.referredUsers.push({
            userId: newUser._id,
            name: newUser.name,
            email: newUser.email,
            joinedDate: new Date(),
            bonusEarned: referralBonus
        });
        referrer.totalReferralEarnings += referralBonus;

        newUser.referredBy = referrerCode;
        newUser.joiningBonus = joiningBonus;

        
        await referrerWallet.save();
        await newUserWallet.save();
        await referrer.save();
        await newUser.save();

        console.log(`Referral bonuses processed: Referrer (${referrer.name}) got ‚Çπ${referralBonus}, New user (${newUser.name}) got ‚Çπ${joiningBonus}`);
    } catch (error) {
        console.error('Error processing referral bonus:', error);
    }
};

const signUp = async (req, res) => {
    try {
        const { name, email, password, cPassword, referralCode } = req.body;
        
        if(password !== cPassword){
            return res.render('signup',{message:'Password not matched'})
        }

        const findUser = await User.findOne({email:email})
        if(findUser){
            return res.render('signup',{message:'User already exists'})
        }

        // Validate referral code if provided
        if (referralCode && referralCode.trim()) {
            const referrer = await User.findOne({ referId: referralCode.trim() });
            if (!referrer) {
                return res.render('signup', { message: 'Invalid referral code' });
            }
        }
        
        const otp = generateOTP()
        const emailSent = await sendVerificationEmail(email,otp);
        
        req.session.userOtp = otp;
        req.session.userData = {name, email, password, referralCode: referralCode?.trim() || null};

        res.render('verify-otp');
        console.log("OTP Send",otp);
        
    } catch (error) {
        console.error('signup error',error)
        res.redirect('/pagenotfound')
    }
}

const securePassword = async (password) => {
    try {
        const passwordHash = await bcrypt.hash(password,10);
        return passwordHash;
    } catch (error) {
        throw error;
    }
}

const verifyOtp = async (req, res) => {
    try{
        const {otp1,otp2,otp3,otp4,otp5,otp6} = req.body;
        const otp = otp1.concat(otp2).concat(otp3).concat(otp4).concat(otp5).concat(otp6)

        if(otp===req.session.userOtp){
            const user = req.session.userData;
            const passwordHash = await securePassword(user.password);

            const saveUserData = new User({
                name: user.name,
                email: user.email,
                phone: user.phone,
                googleId: user.googleId || null,
                password: passwordHash
            })

            await saveUserData.save();

            // referral bonus if referral code was provided
            if (user.referralCode) {
                await processReferralBonus(saveUserData, user.referralCode);
            }

            req.session.user = saveUserData._id;
            res.json({success:true,redirectUrl:'/'})

        } else{
            res.status(400).json({success:false,message:'Invalid OTP Please try again'})
        }

    } catch (error) {
        console.error('Error verifying OTP',error)
        res.status(500).json({success:false,message:'Server Error'})
    }
}

const resendOtp = async (req, res) => {
    try {
        const {email} = req.session.userData;
        console.log('email:',email)
        if(!email){
            return res.status(400).json({success:false,message:'Email not found in session'})
        }

        const otp = generateOTP();
        req.session.userOtp = otp;

        const emailSent = await sendVerificationEmail(email,otp);
        console.log(emailSent)
        if(!emailSent){
            res.status(500).json({success:false,message:'Failed to resend OTP Please try again'})
        } else{
            console.log("Resend OTP",otp);
            res.status(200).json({success:true,message:'Successfully sent OTP'})
        }
    } catch (error) {
        console.error('Error Resending OTP',error)
        res.status(500).json({success:false,message:'Internal Server Error, Please try again'})
    }
}

const loadLoginPage = async (req, res) => {
    try {
        if(!req.session.user){
            return res.render('login')
        } else{
            res.redirect('/')
        }
    } catch (error) {
        res.redirect('/pagenotfound')
    }
}

const login = async (req, res) => {
    try {
        const {email, password} = req.body;
        
        
        if (!password) {
            return res.render('login', {message: 'Password is required'});
        }
        
        const findUser = await User.findOne({isAdmin: 0, email: email});

        if (!findUser) {
            return res.render('login', {message: 'User not found'});
        }
        
        if (findUser.isBlocked) {
            return res.render('login', {message: 'User is Blocked by Admin'});
        }

        
        if (!findUser.password) {
            return res.render('login', {message: 'This account was created with Google. Please use Google Sign-In.'});
        }

        const passwordMatch = await bcrypt.compare(password, findUser.password);
        if (!passwordMatch) {
            return res.render('login', {message: 'Invalid Password'});
        }

        req.session.user = findUser._id;
        res.redirect('/');
        
    } catch (error) {
        console.error('Login Error', error);
        res.render('login', {message: 'Login Failed Try again'});
    }
}

const logout = async (req, res) => {
    try {
        req.session.destroy((err) => {
            if (err) {
                console.log("Session destruction error:", err.message);
                return res.redirect('/pageNotFound');
            }
            console.log('\n\n user logged out')
            return res.redirect('/login?refresh=true');
        });
    } catch (error) {
        console.log("Logout error:", error);
        res.redirect("/pageNotFound");
    }
};

const about=async(req,res)=>{
    try {
        const userId = req.session.user
        const user = await User.findById(userId)
        res.render("about",{user})
    } catch (error) {
        console.log('error',error)
    }
}

const shop=async(req,res)=>{
    try {
        res.render("shop")
    } catch (error) {
        
    }
}

const loadShoppingPage = async (req, res) => {
    try {
        const user = req.session.user;
        let userData = null;
        if (user) {
            userData = await User.findOne({ _id: user });
        }

        const categories = await Category.find({ isListed: true });
        const categoryIDs = categories.map(cat => cat._id);

        const page = parseInt(req.query.page) || 1;
        const limit = 9;
        const skip = (page - 1) * limit;

        const queryObj = {
            isBlocked: false,
            category: { $in: categoryIDs },
            
        };




        const sortObj = { createdAt: -1 };

        const products = await Product.find(queryObj)
            .sort(sortObj)
            .skip(skip)
            .limit(limit)
            .lean();

        console.log('Initial Load Products:', products.length);

        const totalProducts = await Product.countDocuments(queryObj);
        const totalPages = Math.ceil(totalProducts / limit);

        const categoriesWithCounts = await Promise.all(
            categories.map(async (cat) => {
                const count = await Product.countDocuments({
                    category: cat._id,
                    isBlocked: false,
                    quantity: { $gt: 0 }
                });
                return { _id: cat._id, name: cat.name, productCount: count };
            })
        );

        res.render('shop', {
            user: userData,
            products,
            category: categoriesWithCounts,
            totalProducts,
            currentPage: page,
            totalPages,
            selectedCategory: null,
            searchQuery: '',
            minPrice: 0,
            maxPrice: 40000,
            sort: 'relevance',
            alphaFilter: ''
        });
    } catch (error) {
        console.error('Shopping Page Not Found:', error);
        res.redirect('/pagenotfound');
    }
};

const filterProduct = async (req, res) => {
    try {
        const user = req.session.user;
        const { category, query, minPrice, maxPrice, alpha, sort, page = 1 } = req.query;
        const isAjax = req.xhr || req.headers.accept.includes('json');

        
        const categories = await Category.find({ isListed: true });
        const categoryIDs = categories.map(cat => cat._id);

        const queryObj = {
            isBlocked: false,
            quantity: { $gt: 0 },
            category: { $in: categoryIDs } // Default to all listed categories
        };

        // Category filter
        if (category) {
            const findCategory = await Category.findOne({ _id: category, isListed: true });
            if (findCategory) {
                queryObj.category = findCategory._id;
            } else {
                console.warn('Invalid category ID:', category);
                
            }
        }

        // Search filter
        if (query && query.trim()) {
            queryObj.$or = [
                { productName: { $regex: query.trim(), $options: 'i' } },
                { description: { $regex: query.trim(), $options: 'i' } }
            ];
        }

        // Price filter
        if (minPrice || maxPrice) {
            queryObj.salePrice = {};
            const min = minPrice ? parseFloat(minPrice) : 0;
            const max = maxPrice ? parseFloat(maxPrice) : Infinity;
            if (min > 0) queryObj.salePrice.$gte = min;
            if (max < Infinity) queryObj.salePrice.$lte = max;
        }

        // Alphabet filter
        if (alpha) {
            let regex;
            switch (alpha) {
                case 'a-f':
                    regex = '^[a-fA-F]';
                    break;
                case 'g-l':
                    regex = '^[g-lG-L]';
                    break;
                case 'm-r':
                    regex = '^[m-rM-R]';
                    break;
                case 's-z':
                    regex = '^[s-zS-Z]';
                    break;
                default:
                    regex = null;
            }
            if (regex) {
                queryObj.productName = { $regex: regex, $options: 'i' };
            }
        }

        // Pagination
        const itemsPerPage = 9;
        const currentPage = parseInt(page) || 1;
        const skip = (currentPage - 1) * itemsPerPage;

        // Sorting
        const sortObj = {};
        if (sort) {
            switch (sort) {
                case 'price-low':
                    sortObj.salePrice = 1;
                    break;
                case 'price-high':
                    sortObj.salePrice = -1;
                    break;
                case 'newest':
                    sortObj.createdAt = -1;
                    break;
                case 'bestselling':
                    sortObj.salesCount = -1; 
                    break;
                default:
                    sortObj.createdAt = -1;
            }
        } else {
            sortObj.createdAt = -1;
        }

        
        const products = await Product.find(queryObj)
            .sort(sortObj)
            .skip(skip)
            .limit(itemsPerPage)
            .lean();

        console.log(`Page ${currentPage} Products:`, products.length, 'Total Products:', await Product.countDocuments(queryObj));

        // Total products for pagination
        const totalProducts = await Product.countDocuments(queryObj);
        const totalPages = Math.ceil(totalProducts / itemsPerPage);

        // Categories with counts
        const categoriesWithCounts = await Promise.all(
            categories.map(async (cat) => {
                const count = await Product.countDocuments({
                    category: cat._id,
                    isBlocked: false,
                    quantity: { $gt: 0 }
                });
                return { _id: cat._id, name: cat.name, productCount: count };
            })
        );

        // User data and search history
        let userData = null;
        if (user) {
            userData = await User.findOne({ _id: user });
            if (userData && (query || category || alpha)) {
                const searchEntry = {
                    category: category || null,
                    searchedOn: new Date(),
                    query: query || null,
                    alpha: alpha || null
                };
                userData.searchHistory.push(searchEntry);
                await userData.save();
            }
        }

        
        if (isAjax) {
            return res.json({
                products,
                totalProducts,
                totalPages,
                currentPage
            });
        }

        
        res.render('shop', {
            user: userData,
            products,
            category: categoriesWithCounts,
            totalProducts,
            totalPages,
            currentPage,
            selectedCategory: category || null,
            searchQuery: query || '',
            minPrice: minPrice || 0,
            maxPrice: maxPrice || 1000,
            sort: sort || 'relevance',
            alphaFilter: alpha || ''
        });
    } catch (error) {
        console.error('Error while filtering products:', error);
        if (req.xhr || req.headers.accept.includes('json')) {
            return res.status(500).json({ error: 'Server error' });
        }
        res.redirect('/pageNotFound');
    }
};





const errorpage =async(req,res)=>{
    try {
        res.render("errorpage")
    } catch (error) {
        
    }
}

const loadProductDetails = async (req, res) => {
  try {
    const productId = req.params.id;

    
    const product = await Product.findOne({
      _id: productId,
      isBlocked: false,
      status: 'available'
    }).populate('category');

    
    if (!product) {
         const user = req.session.user;
        let userData = null;
        if (user) {
            userData = await User.findOne({ _id: user });
        }
      return res.status(404).render('failure-order', {
        user: userData,
        message: 'Product not found or unavailable',
        title: 'Product Not Available'
      });
    }

    const user = req.session.user ? await User.findById(req.session.user) : null;

    res.render('productDetails', { 
      product, 
      user, 
      stock: product.quantity 
    });
  } catch (error) {
    console.log('Error loading product details:', error);
    res.status(500).render('failure-order', { 
      message: 'Something went wrong. Please try again later.' 
    });
  }
};


const cart = async (req, res) => {
  try {
    const { productId, quantity = 1 } = req.body;
    const userId = req.session.user;

    
    if (!userId) {
      return res.status(401).json({ success: false, message: "Please log in to add items to cart" });
    }

    
    if (!productId || !mongoose.Types.ObjectId.isValid(productId)) {
      return res.status(400).json({ success: false, message: "Invalid product ID" });
    }
    if (!Number.isInteger(quantity) || quantity < 1) {
      return res.status(400).json({ success: false, message: "Quantity must be a positive integer" });
    }

    // Check product exist and stock
    const product = await Product.findById(productId);
    if (!product) {
      return res.status(404).json({ success: false, message: "Product not found" });
    }
    if (product.quantity < quantity) {
      return res.status(400).json({ success: false, message: `Only ${product.quantity} items in stock` });
    }

    // Use salePrice directly - it already has the discount applied
    const effectivePrice = product.salePrice;
    
    if (typeof effectivePrice !== 'number' || isNaN(effectivePrice) || effectivePrice <= 0) {
      return res.status(400).json({ success: false, message: "Invalid product price" });
    }

    // Find or create cart
    let cart = await Cart.findOne({ userId });
    if (!cart) {
      cart = new Cart({ userId, items: [] });
    }

    // Check if product is in cart and quantity limit
    const itemIndex = cart.items.findIndex(item => item.productId.toString() === productId);
    let newQuantity = quantity;
    if (itemIndex > -1) {
      newQuantity = cart.items[itemIndex].quantity + quantity;
      if (newQuantity > 5) {
        return res.status(400).json({ success: false, message: "User limit exceeded: Maximum 5 items per product allowed in cart" });
      }
      // Update existing item
      cart.items[itemIndex].quantity = newQuantity;
      cart.items[itemIndex].totalPrice = effectivePrice * newQuantity;
    } else {
      if (quantity > 5) {
        return res.status(400).json({ success: false, message: "User limit exceeded: Maximum 5 items per product allowed in cart" });
      }
      // Add new item
      cart.items.push({
        productId,
        quantity,
        price: effectivePrice,
        totalPrice: effectivePrice * quantity,
        status: "placed",
        cancellationReason: "none",
      });
    }

    // Validate total quantity against stock
    if (newQuantity > product.quantity) {
      return res.status(400).json({ success: false, message: `Only ${product.quantity} items in stock` });
    }

    
    await cart.save();

    res.status(200).json({ success: true, message: "Product added to cart" });
  } catch (error) {
    console.error("Error adding to cart:", error);
    res.status(500).json({ success: false, message: "Server error" });
  }
};

const removeFromCart = async (req, res) => {
  try {
    const { productId } = req.body;
    const userId = req.session.user;

    if (!userId) {
      return res.status(401).json({ status: false, message: "Please log in first" });
    }

    // checking the cart
    const cart = await Cart.findOne({ userId });
    if (!cart) {
      return res.status(404).json({ status: false, message: "Cart not found" });
    }

    // checking item index in the cart
    const cartItemIndex = cart.items.findIndex(item => item.productId.toString() === productId);
    if (cartItemIndex === -1) {
      return res.status(404).json({ status: false, message: "Product not found in cart" });
    }

    // Remove the item
    cart.items.splice(cartItemIndex, 1);
    await cart.save();

    return res.json({ status: true, message: "Product removed from cart" });
  } catch (error) {
    console.error('Error in removeFromCart:', error);
    return res.status(500).json({ status: false, message: "An error occurred while removing the product from cart" });
  }
};

const loadCart = async (req, res) => {
  try {
    const userId = req.session.user;

    
    if (!userId) {
      if (req.xhr || req.headers.accept.includes('json')) {
        return res.status(401).json({ success: false, message: 'Please log in to view cart', redirect: '/login' });
      }
      return res.redirect('/login');
    }

    
    const userData = await User.findOne({ _id: userId });
    const cart = await Cart.findOne({ userId }).populate('items.productId');

    let cartItems = [];
    let isUpdated = false;
    let priceChanged = false;

    if (cart && cart.items.length > 0) {
      cartItems = cart.items.map((item) => {
        if (!item.productId) {
          console.warn(`Product not found for item: ${item.productId}`);
          return null;
        }

        // Use salePrice directly - it already has the discount applied
        const effectivePrice = item.productId.salePrice;

        // Checking for price changes
        if (item.price !== effectivePrice) {
          item.price = effectivePrice;
          item.totalPrice = item.quantity * effectivePrice;
          priceChanged = true;
          isUpdated = true;
        }

        // checking if product stock is less than cart quantity
        if (item.productId.quantity < item.quantity) {
          item.quantity = item.productId.quantity;
          item.totalPrice = item.quantity * item.price;
          isUpdated = true;
        }

        return {
          productId: item.productId._id,
          name: item.productId.productName,
          image:
            item.productId.productImage && item.productId.productImage.length > 0
              ? `/${item.productId.productImage[0]}`
              : '/placeholder.svg',
          price: item.price,
          quantity: item.quantity,
          totalPrice: item.totalPrice,
          stock: item.productId.quantity,
        };
      }).filter(item => item !== null);

      //  if updates were made in cart then save
      if (isUpdated) {
        await cart.save();
      }
    }

    // Display message from query
    const message = req.query.message ? decodeURIComponent(req.query.message) : null;

    // Render cart
    res.render('cart', {
      user: userData,
      cart: cartItems,
      message,
      priceChanged
    });

  } catch (error) {
    console.error('Error loading cart:', error);
    if (req.xhr || req.headers.accept.includes('json')) {
      return res.status(500).json({ success: false, message: 'Server error while loading cart' });
    }
    res.redirect('/errorpage?message=cart-load-error');
  }
};

const updateCart = async (req, res) => {
  try {
    const { productId, quantity } = req.body;
    const userId = req.session.user;
    if (!productId || quantity < 1) {
      return res.status(400).json({ message: "Invalid product ID or quantity" });
    }
    const cart = await Cart.findOne({ userId }).populate('items.productId');
    if (!cart) {
      return res.status(404).json({ message: "Cart not found" });
    }
    const item = cart.items.find(item => item.productId._id.toString() === productId);
    if (item) {
      
      const product = await Product.findById(productId);
      if (!product) {
        return res.status(404).json({ message: "Product not found" });
      }
      
      
      const effectivePrice = product.salePrice;
      
      item.quantity = quantity;
      item.price = effectivePrice;
      item.totalPrice = quantity * effectivePrice;
      

      await cart.save();
      res.status(200).json({ message: "Cart updated", price: effectivePrice });
    } else {
      res.status(404).json({ message: "Item not found in cart" });
    }
  } catch (error) {
    console.error("Error updating cart:", error);
    res.status(500).json({ message: "Server error" });
  }
};

const addAddress = async (req, res) => {
    try {
        // Check if user is authenticated
        const userId = req.session.user; 
        if (!userId) {
            return res.status(401).json({ message: 'Please log in to add an address.' });
        }

        
        const {
            fullName,
            streetAddress,
            city,
            state,
            zipCode,
            phone,
            addressType = 'Home', 
            altPhone = '', 
        } = req.body;

        
        const errors = [];

        
        if (!fullName || typeof fullName !== 'string' || !/^[A-Za-z\s]{2,}$/.test(fullName)) {
            errors.push('Full Name must be at least 2 characters, letters and spaces only.');
        }

        
        if (!streetAddress || typeof streetAddress !== 'string' || streetAddress.length < 5) {
            errors.push('Street Address must be at least 5 characters.');
        }

        
        if (!city || typeof city !== 'string' || !/^[A-Za-z\s]{2,}$/.test(city)) {
            errors.push('City must be at least 2 characters, letters and spaces only.');
        }

        
        const validStates = [
            'Andaman and Nicobar Islands', 'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar',
            'Chandigarh', 'Chhattisgarh', 'Dadra and Nagar Haveli and Daman and Diu', 'Delhi', 'Goa',
            'Gujarat', 'Haryana', 'Himachal Pradesh', 'Jammu and Kashmir', 'Jharkhand', 'Karnataka',
            'Kerala', 'Ladakh', 'Lakshadweep', 'Madhya Pradesh', 'Maharashtra', 'Manipur', 'Meghalaya',
            'Mizoram', 'Nagaland', 'Odisha', 'Puducherry', 'Punjab', 'Rajasthan', 'Sikkim', 'Tamil Nadu',
            'Telangana', 'Tripura', 'Uttar Pradesh', 'Uttarakhand', 'West Bengal'
        ];
        if (!state || !validStates.includes(state)) {
            errors.push('Please select a valid state.');
        }

        

        const pincode = parseInt(zipCode, 10);
        if (!zipCode || !/^\d{5,6}$/.test(zipCode) || isNaN(pincode)) {
            errors.push('Pin Code must be 5 or 6 digits.');
        }

       
        if (!phone || !/^\d{10}$/.test(phone)) {
            errors.push('Phone Number must be exactly 10 digits.');
        }

        
        if (altPhone && !/^\d{10}$/.test(altPhone)) {
            errors.push('Alternate Phone Number must be exactly 10 digits if provided.');
        }

        
        if (!addressType || typeof addressType !== 'string') {
            errors.push('Address Type must be a valid string.');
        }

        
        if (errors.length > 0) {
            return res.status(400).json({ message: errors.join(' ') });
        }

        
        const newAddress = {
            addressType,
            name: fullName,
            city,
            landMark: streetAddress,
            state,
            pincode,
            phone,
            altPhone,
        };

        
        let userAddress = await Address.findOne({ userId });

        if (userAddress) {
            
            userAddress.address.push(newAddress);
            await userAddress.save();
        } else {
           
            userAddress = new Address({
                userId,
                address: [newAddress],
            });
            await userAddress.save();
        }

        // Return the new added address
        res.status(200).json(newAddress);
    } catch (error) {
        console.error('Error adding address:', error);
        res.status(500).json({ message: 'An error occurred while saving the address.' });
    }
}



const wishlistpage = async (req, res) => {
    try {
        const userId = req.session.user;
        if (!userId) {
            return res.status(401).json({ message: 'Please log in to view your wishlist.' });
        }

        const user = await User.findById(userId);
        if (!user) {
            return res.status(404).json({ message: 'User not found.' });
        }

        const wishlistItems = user.wishlist.map(item => ({
            productId: item.id,
            name: item.name,
            image: item.image,
            price: item.price
        }));

        res.render('wishlist', { wishlistItems, user });
    } catch (error) {
        console.error('Error fetching wishlist:', error);
        res.status(500).send('Internal Server Error');
    }
};

const addToWishlist = async (req, res) => {
    try {
        const userId = req.session.user;
        if (!userId) {
            return res.status(401).json({ success: false, message: 'Please log in to add to wishlist.' });
        }

        const productId = req.params.id;
        const product = await Product.findById(productId);
        if (!product) {
            return res.status(404).json({ success: false, message: 'Product not found.' });
        }

        const user = await User.findById(userId);
        if (!user) {
            return res.status(404).json({ success: false, message: 'User not found.' });
        }

        // Check if product is already in wishlist
        const exists = user.wishlist.some(item => item.id === productId);
        if (exists) {
            return res.status(400).json({ success: false, message: 'Product already in wishlist.' });
        }

        // discount applied
        const effectivePrice = product.salePrice;
        
        user.wishlist.push({
            id: productId,
            image: product.productImage[0],
            name: product.productName,
            price: effectivePrice
        });

        await user.save();
        res.status(200).json({ success: true, message: 'Product added to wishlist.' });
    } catch (error) {
        console.error('Error adding to wishlist:', error);
        res.status(500).json({ success: false, message: 'Internal Server Error' });
    }
};

const removeFromWishlist = async (req, res) => {
    try {
        const userId = req.session.user;
        if (!userId) {
            return res.status(401).json({ message: 'Please log in to remove from wishlist.' });
        }

        const productId = req.params.id;
        const user = await User.findById(userId);
        if (!user) {
            return res.status(404).json({ message: 'User not found.' });
        }

        user.wishlist = user.wishlist.filter(item => item.id !== productId);
        await user.save();

        res.status(200).json({ message: 'Product removed from wishlist.' });
    } catch (error) {
        console.error('Error removing from wishlist:', error);
        res.status(500).json({ message: 'Internal Server Error' });
    }
};



// Load referral page
const loadReferralPage = async (req, res) => {
    try {
        const userId = req.session.user;
        if (!userId) {
            return res.redirect('/login');
        }

        const user = await User.findById(userId);
        if (!user) {
            return res.status(404).send('User not found');
        }

        // Get wallet information for referral
        const wallet = await Wallet.findOne({ userId });

        res.render('referral', {
            user,
            wallet: wallet || { balance: 0, transactions: [] },
            referralCode: user.referId,
            referredUsers: user.referredUsers || [],
            totalEarnings: user.totalReferralEarnings || 0,
            joiningBonus: user.joiningBonus || 0
        });
    } catch (error) {
        console.error('Error loading referral page:', error);
        res.status(500).send('Server Error');
    }
};

// Validate referral code 
const validateReferralCode = async (req, res) => {
    try {
        const { referralCode } = req.body;
        
        if (!referralCode || !referralCode.trim()) {
            return res.json({ valid: false, message: 'Please enter a referral code' });
        }

        const referrer = await User.findOne({ referId: referralCode.trim() });
        
        if (!referrer) {
            return res.json({ valid: false, message: 'Invalid referral code' });
        }

        return res.json({ 
            valid: true, 
            message: `Valid referral code from ${referrer.name}`,
            referrerName: referrer.name 
        });
    } catch (error) {
        console.error('Error validating referral code:', error);
        res.status(500).json({ valid: false, message: 'Server error' });
    }
};

const couponload = async (req, res) => {
    try {
        res.render('coupon');
    } catch (error) {   
        console.error('Error loading coupons page:', error);
    }
}


const location = async(req,res)=>{
    try{
        res.render('locat')
    }
catch(error){
    console.log("errrrrrrrrr")
}    }

module.exports = {
    loadHomePage,
    location,
    pageNotFound,
    loadLoginPage,
    loadSignUpPage,
    signUp,
    login,
    verifyOtp,
    resendOtp,
    logout,
    about,
    // checkout,
    shop,
    loadShoppingPage,
    wishlistpage,
    addToWishlist,
    removeFromWishlist,
    errorpage,
    loadProductDetails,
    filterProduct,
    cart,
    updateCart,
    removeFromCart,
    loadCart,
    addAddress,
    resetPassword,
    renderForgotPassword, 
    forgotPassword,
    renderForgotPasswordOtp,
    verifyForgotPasswordOtp,  
    resendForgotPasswordOtp,
    renderResetPassword,
    couponload,
    loadReferralPage,
    validateReferralCode
}



- fully annalyse the front-end and backend code
- don't allow to create new account when the user already exist , by checking email.
- don't allow to put only space in username ,email,password ,refferal-code.
- don't allow to create an new account without validation .
- so please make sure the whole code in working under the validation.

-don't use react.