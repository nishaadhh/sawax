<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .content-wrapper {
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            margin: 20px;
            padding: 30px;
        }
        .filter-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #dee2e6;
        }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .summary-card h3 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: bold;
        }
        .summary-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
        .table-responsive {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .table {
            margin-bottom: 0;
        }
        .table th {
            background-color: #495057;
            color: white;
            border: none;
            padding: 15px;
            font-weight: 600;
        }
        .table td {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-delivered {
            background-color: #d4edda;
            color: #155724;
        }
        .status-returned {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status-cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }
        .download-buttons {
            gap: 10px;
        }
        .btn-download {
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .no-data {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        .filter-group {
            margin-bottom: 20px;
        }
        .filter-group label {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .period-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .period-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .period-btn:hover, .period-btn.active {
            background: #667eea;
            color: white;
        }
        .top-products {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f1f1f1;
        }
        .product-item:last-child {
            border-bottom: none;
        }
        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar p-3">
                <h4 class="mb-4"><i class="fas fa-chart-bar"></i> Sales Report</h4>
                <nav class="nav flex-column">
                    <a class="nav-link text-white" href="/admin/dashboard">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                    <a class="nav-link text-white" href="/admin/orders">
                        <i class="fas fa-box"></i> Orders
                    </a>
                    <a class="nav-link text-white active" href="/admin/sales-report">
                        <i class="fas fa-chart-line"></i> Sales Report
                    </a>
                    <a class="nav-link text-white" href="/admin/products">
                        <i class="fas fa-shopping-bag"></i> Products
                    </a>
                    <a class="nav-link text-white" href="/admin/users">
                        <i class="fas fa-users"></i> Users
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-md-10">
                <div class="content-wrapper">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1 class="h3"><%= reportTitle %></h1>
                        <div class="d-flex download-buttons">
                            <button class="btn btn-success btn-download" onclick="downloadExcel()">
                                <i class="fas fa-file-excel"></i> Export Excel
                            </button>
                            <button class="btn btn-danger btn-download" onclick="downloadPDF()">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                        </div>
                    </div>

                    <% if (typeof error !== 'undefined') { %>
                        <div class="error-message">
                            <i class="fas fa-exclamation-triangle"></i> <%= error %>
                        </div>
                    <% } %>

                    <!-- Filter Section -->
                    <div class="filter-card">
                        <h5 class="mb-3"><i class="fas fa-filter"></i> Filter Reports</h5>
                        <form method="GET" action="/admin/sales-report" id="filterForm">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="filter-group">
                                        <label>Quick Period Selection:</label>
                                        <div class="period-buttons">
                                            <button type="button" class="period-btn <%= filterParams.period === 'today' ? 'active' : '' %>" onclick="setPeriod('today')">Today</button>
                                            <button type="button" class="period-btn <%= filterParams.period === 'week' ? 'active' : '' %>" onclick="setPeriod('week')">This Week</button>
                                            <button type="button" class="period-btn <%= filterParams.period === 'month' ? 'active' : '' %>" onclick="setPeriod('month')">This Month</button>
                                            <button type="button" class="period-btn <%= filterParams.period === 'year' ? 'active' : '' %>" onclick="setPeriod('year')">This Year</button>
                                            <button type="button" class="period-btn <%= filterParams.period === 'all' ? 'active' : '' %>" onclick="setPeriod('all')">All Time</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="filter-group">
                                        <label for="startDate">Start Date:</label>
                                        <input type="date" class="form-control" id="startDate" name="startDate" value="<%= filterParams.startDate || '' %>">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="filter-group">
                                        <label for="endDate">End Date:</label>
                                        <input type="date" class="form-control" id="endDate" name="endDate" value="<%= filterParams.endDate || '' %>">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="filter-group">
                                        <label>&nbsp;</label>
                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-primary flex-fill">
                                                <i class="fas fa-search"></i> Apply Filter
                                            </button>
                                            <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                                                <i class="fas fa-times"></i> Clear
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" name="period" id="periodInput" value="<%= filterParams.period || 'all' %>">
                        </form>
                    </div>

                    <!-- Summary Cards -->
                    <div class="row mb-4">
                        <div class="col-md-2">
                            <div class="summary-card">
                                <h3><%= summary.totalOrders || 0 %></h3>
                                <p>Total Orders</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="summary-card">
                                <h3>₹<%= (summary.totalRevenue || 0).toFixed(2) %></h3>
                                <p>Total Revenue</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="summary-card">
                                <h3>₹<%= (summary.totalDiscount || 0).toFixed(2) %></h3>
                                <p>Total Discount</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="summary-card">
                                <h3>₹<%= (summary.averageOrderValue || 0).toFixed(2) %></h3>
                                <p>Average Order</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="summary-card">
                                <h3>₹<%= (summary.totalRefunds || 0).toFixed(2) %></h3>
                                <p>Total Refunds</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="summary-card">
                                <h3>₹<%= ((summary.totalRevenue || 0) - (summary.totalRefunds || 0)).toFixed(2) %></h3>
                                <p>Net Revenue</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Section -->
                    <% if (chartData && chartData.length > 0) { %>
                        <div class="chart-container">
                            <h5 class="mb-3"><i class="fas fa-chart-line"></i> Sales Trend (Last 30 Days)</h5>
                            <canvas id="salesChart" width="400" height="100"></canvas>
                        </div>
                    <% } %>

                    <!-- Top Products -->
                    <% if (topProducts && topProducts.length > 0) { %>
                        <div class="top-products">
                            <h5 class="mb-3"><i class="fas fa-trophy"></i> Top Selling Products</h5>
                            <% topProducts.forEach(product => { %>
                                <div class="product-item">
                                    <div>
                                        <strong><%= product.productName %></strong>
                                        <small class="text-muted">Qty: <%= product.totalQuantity %></small>
                                    </div>
                                    <div class="text-end">
                                        <strong>₹<%= product.totalRevenue.toFixed(2) %></strong>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    <% } %>

                    <!-- Orders Table -->
                    <div class="table-responsive">
                        <% if (orders && orders.length > 0) { %>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Date</th>
                                        <th>Customer</th>
                                        <th>Products</th>
                                        <th>Payment Method</th>
                                        <th>Status</th>
                                        <th>Gross Amount</th>
                                        <th>Discount</th>
                                        <th>Delivery</th>
                                        <th>Final Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% orders.forEach(order => { %>
                                        <tr>
                                            <td><strong><%= order.orderId %></strong></td>
                                            <td><%= moment(order.createdOn).format('DD/MM/YYYY') %></td>
                                            <td>
                                                <div>
                                                    <strong><%= order.userId?.name || 'N/A' %></strong>
                                                    <br>
                                                    <small class="text-muted"><%= order.userId?.email || '' %></small>
                                                </div>
                                            </td>
                                            <td>
                                                <% order.orderedItems.forEach(item => { %>
                                                    <small><%= item.productName %> (x<%= item.quantity %>)</small><br>
                                                <% }); %>
                                            </td>
                                            <td>
                                                <span class="badge bg-info"><%= order.paymentMethod.toUpperCase() %></span>
                                            </td>
                                            <td>
                                                <span class="status-badge status-<%= order.status %>">
                                                    <%= order.status.toUpperCase() %>
                                                </span>
                                            </td>
                                            <td>₹<%= order.totalPrice.toFixed(2) %></td>
                                            <td>₹<%= order.discount.toFixed(2) %></td>
                                            <td>₹<%= order.deliveryCharge.toFixed(2) %></td>
                                            <td><strong>₹<%= order.finalAmount.toFixed(2) %></strong></td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        <% } else { %>
                            <div class="no-data">
                                <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                <h4>No sales data found</h4>
                                <p>Try adjusting your filter criteria to see results.</p>
                            </div>
                        <% } %>
                    </div>

                    <!-- Pagination -->
                    <% if (totalPages > 1) { %>
                        <div class="pagination-container">
                            <nav>
                                <ul class="pagination">
                                    <% if (currentPage > 1) { %>
                                        <li class="page-item">
                                            <a class="page-link" href="?page=<%= currentPage - 1 %>&period=<%= filterParams.period %>&startDate=<%= filterParams.startDate || '' %>&endDate=<%= filterParams.endDate || '' %>">Previous</a>
                                        </li>
                                    <% } %>
                                    
                                    <% for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) { %>
                                        <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                            <a class="page-link" href="?page=<%= i %>&period=<%= filterParams.period %>&startDate=<%= filterParams.startDate || '' %>&endDate=<%= filterParams.endDate || '' %>"><%= i %></a>
                                        </li>
                                    <% } %>
                                    
                                    <% if (currentPage < totalPages) { %>
                                        <li class="page-item">
                                            <a class="page-link" href="?page=<%= currentPage + 1 %>&period=<%= filterParams.period %>&startDate=<%= filterParams.startDate || '' %>&endDate=<%= filterParams.endDate || '' %>">Next</a>
                                        </li>
                                    <% } %>
                                </ul>
                            </nav>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize chart if data exists
        <% if (chartData && chartData.length > 0) { %>
            const ctx = document.getElementById('salesChart').getContext('2d');
            const chartData = <%- JSON.stringify(chartData) %>;
            
            const labels = chartData.map(item => {
                const date = new Date(item._id.day);
                return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
            });
            
            const revenueData = chartData.map(item => item.dailyRevenue);
            const orderData = chartData.map(item => item.dailyOrders);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenue (₹)',
                        data: revenueData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Orders',
                        data: orderData,
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Revenue (₹)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Orders'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Daily Sales Performance'
                        }
                    }
                }
            });
        <% } %>

        // Filter functions
        function setPeriod(period) {
            document.getElementById('periodInput').value = period;
            
            // Clear date inputs if not custom
            if (period !== 'custom') {
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
            }
            
            // Update active button
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Auto-submit if not custom
            if (period !== 'custom') {
                document.getElementById('filterForm').submit();
            }
        }

        function clearFilters() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('periodInput').value = 'all';
            
            // Update active button
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.period-btn[onclick="setPeriod(\'all\')"]').classList.add('active');
            
            document.getElementById('filterForm').submit();
        }

        // Download functions
        function downloadExcel() {
            const params = new URLSearchParams(window.location.search);
            const downloadUrl = '/admin/sales-report/download/excel?' + params.toString();
            window.location.href = downloadUrl;
        }

        function downloadPDF() {
            const params = new URLSearchParams(window.location.search);
            const downloadUrl = '/admin/sales-report/download/pdf?' + params.toString();
            window.location.href = downloadUrl;
        }

        // Handle custom date range
        document.getElementById('startDate').addEventListener('change', function() {
            document.getElementById('periodInput').value = 'custom';
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        });

        document.getElementById('endDate').addEventListener('change', function() {
            document.getElementById('periodInput').value = 'custom';
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        });
    </script>
</body>
</html>