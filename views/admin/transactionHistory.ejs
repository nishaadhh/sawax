<%- include('../partials/admin/header') %>

<div class="container mt-4">
  <h2>Transaction History</h2>
  
  <!-- Filters Form -->
  <form action="/admin/transactions" method="GET" class="mb-4">
    <div class="row">
      <div class="col-md-3">
        <input type="text" name="userSearch" class="form-control" placeholder="Search by user name/email" value="<%= filters.userSearch || '' %>">
      </div>
      <div class="col-md-2">
        <input type="date" name="fromDate" class="form-control" value="<%= filters.fromDate || '' %>">
      </div>
      <div class="col-md-2">
        <input type="date" name="toDate" class="form-control" value="<%= filters.toDate || '' %>">
      </div>
      <div class="col-md-2">
        <select name="type" class="form-control">
          <option value="">All Types</option>
          <option value="credit" <%= filters.type === 'credit' ? 'selected' : '' %>>Credit</option>
          <option value="debit" <%= filters.type === 'debit' ? 'selected' : '' %>>Debit</option>
        </select>
      </div>
      <div class="col-md-2">
        <select name="purpose" class="form-control">
          <option value="">All Purposes</option>
          <option value="purchase" <%= filters.purpose === 'purchase' ? 'selected' : '' %>>Purchase</option>
          <option value="refund" <%= filters.purpose === 'refund' ? 'selected' : '' %>>Refund</option>
          <option value="cancellation" <%= filters.purpose === 'cancellation' ? 'selected' : '' %>>Cancellation</option>
          <option value="return" <%= filters.purpose === 'return' ? 'selected' : '' %>>Return</option>
          <option value="wallet_add" <%= filters.purpose === 'wallet_add' ? 'selected' : '' %>>Wallet Add</option>
          <option value="wallet_withdraw" <%= filters.purpose === 'wallet_withdraw' ? 'selected' : '' %>>Wallet Withdraw</option>
        </select>
      </div>
      <div class="col-md-2">
        <select name="status" class="form-control">
          <option value="">All Statuses</option>
          <option value="completed" <%= filters.status === 'completed' ? 'selected' : '' %>>Completed</option>
          <option value="pending" <%= filters.status === 'pending' ? 'selected' : '' %>>Pending</option>
          <option value="failed" <%= filters.status === 'failed' ? 'selected' : '' %>>Failed</option>
          <option value="refunded" <%= filters.status === 'refunded' ? 'selected' : '' %>>Refunded</option>
        </select>
      </div>
      <div class="col-md-1">
        <button type="submit" class="btn btn-primary">Filter</button>
      </div>
    </div>
  </form>

  <!-- Totals Summary -->
  <div class="card mb-4">
    <div class="card-body">
      <h5>Totals for Filtered Results</h5>
      <p>Total Credits: <%= totals.totalCredits %></p>
      <p>Total Debits: <%= totals.totalDebits %></p>
      <p>Net Change: <%= totals.net %></p>
      <p>Total Transactions: <%= totals.count %></p>
    </div>
  </div>

  <!-- Transactions Table -->
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Transaction ID</th>
        <th>User</th>
        <th>Amount</th>
        <th>Type</th>
        <th>Purpose</th>
        <th>Status</th>
        <th>Date</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
      <% if (transactions.length > 0) { %>
        <% transactions.forEach(tx => { %>
          <tr>
            <td><%= tx.transactionId %></td>
            <td><%= tx.userId ? `${tx.userId.name} (${tx.userId.email})` : 'N/A' %></td>
            <td><%= tx.amount %></td>
            <td><%= tx.transactionType %></td>
            <td><%= tx.purpose %></td>
            <td><%= tx.status %></td>
            <td><%= tx.createdAt.toLocaleString() %></td>
            <td><%= tx.description %></td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr><td colspan="8">No transactions found.</td></tr>
      <% } %>
    </tbody>
  </table>

  <!-- Pagination -->
  <nav>
    <ul class="pagination">
      <% for (let i = 1; i <= pages; i++) { %>
        <li class="page-item <%= i === currentPage ? 'active' : '' %>">
          <a class="page-link" href="/admin/transactions?page=<%= i %>&<%= new URLSearchParams(filters).toString() %>"><%= i %></a>
        </li>
      <% } %>
    </ul>
  </nav>

  <!-- Export Button -->
  <a href="/admin/transactions/download/csv?<%= new URLSearchParams(filters).toString() %>" class="btn btn-success">Download CSV</a>
</div>

<%- include('../partials/admin/footer') %>





<!-- grok -->